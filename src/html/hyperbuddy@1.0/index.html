<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="icon"
            type="image/png"
            href="http://arweave.net/rBcLwnVU2fWNEKUW8PY0TzEAPuCHMj2Vp6z6CedHJf0"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="/~hyperbuddy@1.0/styles.css" />

        <title>HyperBEAM</title>
    </head>
    <body>
        <header>
            <div class="header-inner">
                <div class="logo">
                    <img
                        src="https://arweave.net/Ggr1cz-jbiDS2gAVFHxkoKzmNQQD4WcMTfipWyuEmgY"
                        alt="hyperbeam-logo"
                    />
                </div>
                <div class="subheader">
                    <div class="subheader-value">
                        <p>Operator:</p>
                        <button id="operator-action" disabled="true">
                            Loading...
                        </button>
                    </div>
                </div>
            </div>
        </header>
        <div class="view-wrapper">
            <div class="message-id-wrapper">
                <span>Message Id:</span>
                <p class="message-value">...</p>
                <svg
                    width="20"
                    height="20"
                    viewBox="0 0 9 9"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        d="M3.93945 0.34407C6.0128 -0.482774 7.8625 0.43974 7.89746 0.457351L7.32812 5.89876C7.30668 5.89005 5.11956 5.00545 3.65137 5.81477C2.40855 6.49984 0.0246489 5.9639 0 5.95833L0.467773 0.16243C0.467773 0.16243 1.84627 1.17878 3.93945 0.34407ZM4.11523 1.61262H4.07324V2.67122C3.71213 2.67868 3.35039 2.68548 2.98926 2.68098V1.62337C2.85511 1.62155 2.72009 1.61807 2.58594 1.61262V4.13313C2.7201 4.13949 2.8551 4.14303 2.98926 4.14485V3.0345C3.35039 3.03967 3.71213 3.03127 4.07324 3.02376V4.13411C4.08769 4.13411 4.10164 4.13404 4.11523 4.13313C4.23589 4.13131 4.35701 4.12902 4.47852 4.1263V1.60481C4.35701 1.60663 4.23589 1.6099 4.11523 1.61262ZM4.74805 2.72591V3.94661C4.81014 3.94661 4.8715 3.94563 4.93359 3.94563C4.94143 3.9057 4.94821 3.86656 4.95605 3.82747C4.97439 3.85387 4.99747 3.87843 5.02539 3.89973C5.05327 3.92013 5.08552 3.9365 5.12207 3.94759C5.15955 3.96034 5.20091 3.96707 5.24707 3.96712C5.32928 3.96797 5.40275 3.95094 5.46484 3.91341C5.52847 3.87674 5.57848 3.8255 5.61426 3.75911C5.65 3.69268 5.66697 3.61682 5.66699 3.53255C5.66699 3.44468 5.64904 3.36654 5.6123 3.29915C5.57652 3.23027 5.52651 3.17525 5.46289 3.13606C5.40088 3.09431 5.32817 3.07336 5.24609 3.07161C5.17531 3.07076 5.11654 3.08549 5.06934 3.1136C5.02211 3.14005 4.98404 3.17532 4.95605 3.21712V2.72493C4.88617 2.72493 4.81706 2.72505 4.74805 2.72591ZM5.2041 3.25032C5.25282 3.25037 5.29652 3.26163 5.33398 3.2845C5.37247 3.30839 5.40274 3.34121 5.42285 3.38216C5.44466 3.42306 5.45604 3.4701 5.45605 3.52376C5.45605 3.5774 5.44463 3.62531 5.42285 3.66536C5.40274 3.70459 5.37245 3.7351 5.33398 3.75813C5.29645 3.78027 5.25296 3.79129 5.2041 3.79134C5.15513 3.79048 5.10987 3.77921 5.07227 3.75618C5.03479 3.73235 5.0062 3.70054 4.98438 3.66145C4.96341 3.62055 4.95315 3.57255 4.95312 3.51887C4.95312 3.46522 4.96345 3.4183 4.98438 3.37825C5.00618 3.33742 5.03481 3.30556 5.07227 3.28255C5.10987 3.26037 5.15513 3.24947 5.2041 3.25032Z"
                        fill="black"
                    />
                    <path
                        d="M7.99475 0.487231C8.0855 0.494902 8.09239 0.495496 8.09291 0.495578C8.09292 0.495498 8.0929 0.49562 8.09291 0.495578C8.09288 0.495755 8.09282 0.496237 8.09277 0.496588C8.09268 0.497293 8.09254 0.498353 8.09236 0.499753C8.09198 0.502565 8.09144 0.506788 8.0907 0.512344C8.08924 0.523453 8.0871 0.539978 8.08424 0.561633C8.07852 0.60497 8.07009 0.668887 8.05925 0.751105C8.03757 0.915535 8.00627 1.15326 7.96774 1.44645C7.89068 2.03286 7.7847 2.84117 7.66922 3.72863C7.43824 5.50364 7.16905 7.59518 7.0162 8.86194L6.81965 8.84639C6.97257 7.5791 7.24174 5.48714 7.47271 3.7122C7.5882 2.8247 7.69417 2.01639 7.77124 1.42995C7.80977 1.13674 7.84107 0.898985 7.86275 0.734538C7.87359 0.652319 7.88201 0.588408 7.88774 0.545065C7.8906 0.523394 7.89283 0.506828 7.8943 0.495713C7.89503 0.490184 7.89558 0.485998 7.89595 0.483189C7.89614 0.481782 7.89627 0.480665 7.89637 0.479957C7.89672 0.479947 7.90255 0.479437 7.99475 0.487231Z"
                        fill="black"
                    />
                    <ellipse
                        cx="7.98676"
                        cy="0.187845"
                        rx="0.187936"
                        ry="0.187845"
                        fill="black"
                    />
                </svg>
            </div>
            <div class="explorer-view-flex">
                <div class="bg-video">
                    <video
                        src="https://arweave.net/tJd9JJa8ap5dHHvRAAPOE4Gh6VAY4h8KpBY1gzrtVWo"
                        alt="bg-hyperbeam-video"
                        autoplay
                        loop
                        muted
                        playsinline
                    ></video>
                </div>
                <div class="explorers-wrapper">
                    <div class="explorer-view">
                        <div class="signature-wrapper border-wrapper-primary">
                            <div class="signature-line">
                                <span>Signature</span>
                                <p>...</p>
                            </div>
                            <div class="signature-line">
                                <span>Signer</span>
                                <p>...</p>
                            </div>
                        </div>
                        <div class="explorer-wrapper">
                            <div class="explorer-header">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    fill="#000"
                                    viewBox="0 0 256 256"
                                >
                                    <path
                                        d="M232,80a55.67,55.67,0,0,1-16.4,39.6l-30.07,30.06a8,8,0,0,1-11.31-11.32l30.07-30.06a40,40,0,1,0-56.57-56.56L117.66,81.77a8,8,0,0,1-11.32-11.32L136.4,40.4A56,56,0,0,1,232,80Zm-93.66,94.22-30.06,30.06a40,40,0,1,1-56.56-56.57l30.05-30.05a8,8,0,0,0-11.32-11.32L40.4,136.4a56,56,0,0,0,79.2,79.2l30.06-30.07a8,8,0,0,0-11.32-11.31Z"
                                    ></path>
                                </svg>
                                <p>Links</p>
                            </div>
                            <div id="links-explorer" class="explorer"></div>
                            <div class="explorer-footer">
                                <p id="links-explorer-footer-value">
                                    (0) Links
                                </p>
                            </div>
                        </div>

                        <div class="explorer-wrapper">
                            <div class="explorer-header">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    fill="#000"
                                    viewBox="0 0 256 256"
                                >
                                    <path
                                        d="M120,176h-8v-4a28,28,0,0,0-56,0v4H48a8,8,0,0,0-8,8v40a8,8,0,0,0,8,8h72a8,8,0,0,0,8-8V184A8,8,0,0,0,120,176Zm-48-4a12,12,0,0,1,24,0v4H72Zm40,44H56V192h56ZM213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40v88a8,8,0,0,0,16,0V40h88V88a8,8,0,0,0,8,8h48V216H160a8,8,0,0,0,0,16h40a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160Z"
                                    ></path>
                                </svg>
                                <p>Signed Headers</p>
                            </div>
                            <div
                                id="signed-headers-explorer"
                                class="explorer"
                            ></div>
                            <div class="explorer-footer">
                                <p id="headers-explorer-footer-value">
                                    (0) Headers
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="visual-wrapper">
                    <div class="tabs-wrapper">
                        <div class="tabs">
                            <button
                                class="tab-button active"
                                data-id="cacheviz@1.0/index"
                                data-tab="cacheviz-tab"
                            >
                                Cacheviz
                            </button>
                            <button
                                class="tab-button"
                                data-id="hyperbuddy@1.0/format"
                                data-tab="hyperbuddy-tab"
                            >
                                Hyperbuddy
                            </button>
                        </div>
                    </div>
                    <div class="visual-body"></div>
                </div>
            </div>
        </div>
        <footer>
            <div class="footer-inner">
                <div class="subheader">
                    <div class="subheader-value">
                        <p>Status:</p>
                        <div class="subheader-indicator-wrapper">
                            <div class="subheader-indicator"></div>
                            <p>Live</p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

        <script>
            function parseHeaders(input) {
                const out = {};
                input
                    .split("\n")
                    .map((l) => l.trim())
                    .filter((l) => l && l.includes(":"))
                    .forEach((line) => {
                        const idx = line.indexOf(":");
                        const key = line.slice(0, idx).trim();
                        const val = line.slice(idx + 1).trim();
                        out[key] = { data: val };
                        if (key.includes("+link")) out[key].isLink = true;
                    });
                return out;
            }

            /**
             * Parse a Signature-Input header value into structured entries.
             * @param {string} inputHeader – the raw Signature-Input header *value* (no “Signature-Input:” prefix)
             */
            function parseSignatureInput(inputHeader) {
                return inputHeader.split(/\s*,\s*/).map((entry) => {
                    // Label is everything before the first '='
                    const eq = entry.indexOf("=");
                    const label = entry.slice(0, eq).trim();

                    // Fields are inside the first "(...)"
                    const parenMatch = entry.match(/=\(\s*([^)]+)\s*\)/);
                    const fields = parenMatch
                        ? Array.from(
                              parenMatch[1].matchAll(/"([^"]+)"/g),
                              (m) => m[1]
                          )
                        : [];

                    // Pull out any ;key="value" pairs
                    const paramRegex = /;\s*([^=;\s]+)\s*=\s*"([^"]*)"/g;
                    const params = {};
                    let m;
                    while ((m = paramRegex.exec(entry)) !== null) {
                        params[m[1]] = m[2];
                    }

                    return {
                        label,
                        fields,
                        alg: params.alg || "",
                        keyid: params.keyid || "",
                        ...(params.tag ? { tag: params.tag } : {}),
                    };
                });
            }

            function joinHeaders(headers) {
                return Array.from(headers.entries())
                    .map(([name, value]) => `${name}: ${value}`)
                    .join("\n");
            }

            /**
             * Given your parsed headers object (from parseHeaders) and the raw
             * Signature-Input header value, return a new object containing
             * only those headers which were covered by the signature-input.
             */
            function filterSignedHeaders(parsedHeaders, signatureInputValue) {
                const sigInputs = parseSignatureInput(signatureInputValue);

                // Collect all the field names covered
                const covered = new Set(
                    sigInputs.flatMap((si) =>
                        si.fields.map((f) => f.toLowerCase())
                    )
                );

                // Filter parsedHeaders keys by membership in covered
                return Object.fromEntries(
                    Object.entries(parsedHeaders).filter(([headerName]) =>
                        covered.has(headerName.toLowerCase())
                    )
                );
            }

            /**
             * @param {string} sigInputRaw
             * @returns {Promise<string>} the derived “address” of the first non-HMAC signer
             */
            async function getSignerAddress(sigInputRaw) {
                const entries = parseSignatureInput(sigInputRaw);
                if (!entries.length) return "Unknown";

                // Pick the first entry whose alg isn’t hmac-sha256 (i.e. the real pubkey)
                const realEntry =
                    entries.find(
                        (e) => e.alg.toLowerCase() !== "hmac-sha256"
                    ) || entries[0];
                const rawKeyId = realEntry.keyid;

                // Now decode it to bytes (base64url → Uint8Array)
                const pubKeyBytes = base64UrlToUint8Array(rawKeyId);

                // sha-256 the public key bytes
                const hash = await crypto.subtle.digest("SHA-256", pubKeyBytes);
                const hashArr = new Uint8Array(hash);

                // base64url-encode the hash to get your “address”
                const address = btoa(String.fromCharCode(...hashArr))
                    .replace(/\+/g, "-")
                    .replace(/\//g, "_")
                    .replace(/=+$/, "");

                return address;
            }

            /** Decode base64url string → Uint8Array */
            function base64UrlToUint8Array(b64url) {
                let b64 = b64url.replace(/-/g, "+").replace(/_/g, "/");
                // Pad to multiple of 4
                while (b64.length % 4) b64 += "=";
                const bin = atob(b64);
                const arr = new Uint8Array(bin.length);
                for (let i = 0; i < bin.length; i++) {
                    arr[i] = bin.charCodeAt(i);
                }
                return arr;
            }

            async function renderExplorer(container, parsed, depth = 0) {
                const body = document.createElement("div");
                body.className = "explorer-body";

                Object.entries(parsed).forEach(
                    ([headerKey, { data, isLink }], idx, arr) => {
                        const wrapper = document.createElement("div");
                        wrapper.className = "explorer-body-row-wrapper";

                        const row = document.createElement("div");
                        row.className = "explorer-body-row";
                        row.style.paddingLeft = `${depth * 20 + 15}px`;

                        let arrow, nestedBody;
                        if (isLink) {
                            row.classList.add("explorer-action");

                            arrow = document.createElement("span");
                            arrow.className = "explorer-body-row-indicator";
                            row.appendChild(arrow);

                            wrapper._loaded = false;
                            wrapper._isOpen = false;

                            row.addEventListener("click", async () => {
                                if (!wrapper._loaded) {
                                    wrapper._loaded = true;
                                    try {
                                        const res = await fetch(
                                            `${window.location.origin}/${data}`
                                        );
                                        const raw = joinHeaders(
                                            res.headers
                                        ).trim();
                                        const child = parseHeaders(raw);

                                        await renderExplorer(
                                            nestedBody,
                                            child,
                                            depth + 1
                                        );
                                    } catch (e) {
                                        console.error("Fetch failed:", e);
                                    }
                                    wrapper._isOpen = true;
                                    nestedBody.style.display = "flex";
                                    row.classList.add("explorer-body-row-open");
                                    arrow.classList.add(
                                        "explorer-body-row-indicator-open"
                                    );
                                } else {
                                    wrapper._isOpen = !wrapper._isOpen;
                                    if (wrapper._isOpen) {
                                        nestedBody.style.display = "flex";
                                        row.classList.add(
                                            "explorer-body-row-open"
                                        );
                                        arrow.classList.add(
                                            "explorer-body-row-indicator-open"
                                        );
                                    } else {
                                        nestedBody.style.display = "none";
                                        row.classList.remove(
                                            "explorer-body-row-open"
                                        );
                                        arrow.classList.remove(
                                            "explorer-body-row-indicator-open"
                                        );
                                    }
                                }
                            });
                        }

                        const keySpan = document.createElement("span");
                        keySpan.textContent = headerKey + ":";
                        row.appendChild(keySpan);

                        const value = document.createElement("p");
                        if (isLink)
                            value.classList.add("explorer-body-link-value");
                        value.textContent = data;
                        row.appendChild(value);

                        wrapper.appendChild(row);

                        nestedBody = document.createElement("div");
                        nestedBody.className = "explorer-body";
                        nestedBody.style.display = "none";
                        wrapper.appendChild(nestedBody);

                        body.appendChild(wrapper);
                    }
                );

                container.appendChild(body);
            }

            function renderSignature(signature, signer) {
                const wrapper = document.querySelector(".signature-wrapper");

                while (wrapper.firstChild) {
                    wrapper.removeChild(wrapper.firstChild);
                }

                const signatureLine = document.createElement("div");
                signatureLine.classList.add("signature-line");

                const signatureKey = document.createElement("span");
                signatureKey.innerText = "Signature";
                signatureLine.appendChild(signatureKey);

                const signatureValue = document.createElement("p");
                signatureValue.innerText = signature;
                signatureValue.classList.add("signature-value", "copy-hover");
                signatureLine.appendChild(signatureValue);

                const signerLine = document.createElement("div");
                signerLine.classList.add("signature-line");

                const signerKey = document.createElement("span");
                signerKey.innerText = "Signer";
                signerLine.appendChild(signerKey);

                const signerValue = document.createElement("p");
                signerValue.innerText = signer;
                signerValue.classList.add("signer-value", "copy-hover");
                signerLine.appendChild(signerValue);

                wrapper.appendChild(signatureLine);
                wrapper.appendChild(signerLine);

                // Add class or ID here for copy tooltip
                enableTooltipAndCopy(".signature-value");
                enableTooltipAndCopy(".signer-value");
                enableTooltipAndCopy(".message-value");
                enableTooltipAndCopy("#operator-action");
            }

            function enableTooltipAndCopy(selector) {
                const el = document.querySelector(selector);
                if (!el) return;

                // Create tooltip
                const tooltip = document.createElement("div");
                tooltip.className = "custom-tooltip";
                tooltip.style.position = "absolute";
                tooltip.style.backgroundColor = "#333";
                tooltip.style.color = "#fff";
                tooltip.style.padding = "5px 10px";
                tooltip.style.borderRadius = "4px";
                tooltip.style.fontSize = "12px";
                tooltip.style.whiteSpace = "nowrap";
                tooltip.style.display = "none";
                tooltip.style.zIndex = "9999";
                tooltip.style.pointerEvents = "none";
                document.body.appendChild(tooltip);

                el.style.cursor = "pointer";

                el.addEventListener("mouseenter", (e) => {
                    tooltip.textContent = "Click to copy";
                    tooltip.style.display = "block";
                });

                el.addEventListener("mousemove", (e) => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    tooltip.style.left = `${
                        e.clientX - tooltipRect.width / 2
                    }px`;
                    tooltip.style.top = `${
                        e.clientY - tooltipRect.height - 10
                    }px`;
                });

                el.addEventListener("mouseleave", () => {
                    tooltip.style.display = "none";
                });

                el.addEventListener("click", async () => {
                    try {
                        await navigator.clipboard.writeText(el.innerText);
                        tooltip.textContent = "Copied!";
                        setTimeout(() => {
                            tooltip.style.display = "none";
                        }, 1000);
                    } catch (err) {
                        console.error("Copy failed", err);
                    }
                });
            }

            async function renderInitialMessage() {
                const res = await fetch(window.location.href);
                const raw = joinHeaders(res.headers).trim();
                const parsed = parseHeaders(raw);

                const signature = res.headers.get("signature");
                if (signature) {
                    const signatureInput =
                        parsed["signature-input"]?.data ?? "";

                    const signer = signatureInput
                        ? await getSignerAddress(signatureInput)
                        : "Unknown";

                    renderSignature(signature, signer);
                }

                // Get the signature-input header string
                const sigInputRaw = parsed["signature-input"]?.data;

                // If it's missing, render everything
                const toRender = sigInputRaw
                    ? filterSignedHeaders(parsed, sigInputRaw)
                    : parsed;

                renderExplorer(
                    document.getElementById("signed-headers-explorer"),
                    toRender,
                    0
                );

                document.getElementById(
                    "headers-explorer-footer-value"
                ).innerText = `(${Object.keys(toRender).length}) Headers`;

                let links = {};
                for (const key of Object.keys(parsed)) {
                    if (key.includes("+link")) {
                        links[key] = parsed[key];
                    }
                }

                if (Object.keys(links).length > 0) {
                    renderExplorer(
                        document.getElementById("links-explorer"),
                        links,
                        0
                    );

                    document.getElementById(
                        "links-explorer-footer-value"
                    ).innerText = `(${Object.keys(links).length}) Links`;
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                const container = document.querySelector(".visual-body");
                const tabs = document.querySelectorAll(".tab-button");

                const makeIframe = (device) => {
                    const iframe = document.createElement("iframe");
                    iframe.src = `${window.location.href}/~${device}`;
                    iframe.id = "preview-frame";
                    iframe.style.width = "100%";
                    iframe.style.height = "100%";
                    return iframe;
                };

                const initial = document.querySelector(".tab-button.active");
                if (initial)
                    container.appendChild(makeIframe(initial.dataset.id));

                tabs.forEach((tab) => {
                    tab.addEventListener("click", () => {
                        document
                            .querySelectorAll(".tab-button.active")
                            .forEach((t) => t.classList.remove("active"));
                        tab.classList.add("active");

                        const old = document.getElementById("preview-frame");
                        if (old) old.remove();

                        container.appendChild(makeIframe(tab.dataset.id));
                    });
                });
            });

            renderInitialMessage();
        </script>

        <script type="module">
            import { fetchInfo } from "/~hyperbuddy@1.0/devices.js";

            fetchInfo();
        </script>
    </body>
</html>
